name: 抓取家宽 VPN (保留地区+过滤219)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  scrape-filter-keep-info:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装工具
        run: |
          # 安装 lynx，它可以把 HTML 网页变成整齐的文本，保留 IP 和地区的对应关系
          sudo apt-get update
          sudo apt-get install -y lynx

      - name: 抓取并处理
        env:
          VPN_SOURCE_URL: ${{ secrets.VPN_SOURCE_URL }}
        run: |
          mkdir -p 家宽
          cd 家宽
          
          echo "1. 正在获取数据并转换为文本格式..."
          # -dump: 转换为文本
          # -width=300: 防止行被截断，确保 IP 和国家在同一行
          lynx -dump -width=300 "$VPN_SOURCE_URL" > raw_text.txt

          echo "2. 提取包含 IP 的有效行..."
          # 筛选包含类似 x.x.x.x 格式的行
          grep -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" raw_text.txt > valid_lines.txt

          # ----------------------------------------------------
          # 核心逻辑：使用 awk 进行智能过滤和格式化
          # ----------------------------------------------------
          
          # 定义一个函数来生成 Markdown 头部
          write_header() {
            echo "# $1" > "$2"
            echo "" >> "$2"
            echo "> 更新时间: $(date '+%Y-%m-%d %H:%M:%S')" >> "$2"
            echo "" >> "$2"
            # 假设网页转换后的前三列通常是 IP 端口 地区，这里做一个通用表头
            echo "| 原始信息行 (IP/端口/地区) |" >> "$2"
            echo "| :--- |" >> "$2"
          }

          # --- 任务 1: 生成 非 219 的列表 (重点) ---
          write_header "非 219 开头 IP 列表" "非219IP.md"
          
          # 逻辑解释：
          # !/\b219\./ : 不匹配单词边界为 219. 的内容 (防止误杀 1.2.219.5)
          # {print "| " $0 " |"} : 把整行内容放入表格列中
          awk '!/\b219\./ {print "| " $0 " |"}' valid_lines.txt >> 非219IP.md

          # --- 任务 2: 生成 完整列表 (可选，如果你还需要的话) ---
          write_header "完整家宽 VPN 列表" "README.md"
          awk '{print "| " $0 " |"}' valid_lines.txt >> README.md

          # 清理临时文件
          rm raw_text.txt valid_lines.txt

      - name: 提交并推送
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "更新: VPN列表 (保留地区信息) [$(date '+%H:%M')]"
            git push
          else
            echo "无变化。"
          fi
